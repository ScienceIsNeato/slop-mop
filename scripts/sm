#!/bin/bash
# Slop-Mop CLI wrapper — runs directly from the submodule.
#
# This script is the entry point for `sm` commands. It finds the
# slop-mop submodule directory and runs the CLI module directly,
# ensuring each project uses its own isolated copy.
#
# Usage:
#   ./slop-mop/scripts/sm validate commit
#   ./slop-mop/scripts/sm init
#   ./slop-mop/scripts/sm config --show

set -euo pipefail

# Resolve the slop-mop directory (parent of scripts/)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SLOP_MOP_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Determine project root: if slop-mop has a .git directory (not file),
# it's the primary project. Otherwise it's a submodule and we go up one level.
if [ -d "$SLOP_MOP_DIR/.git" ]; then
    # slop-mop IS the project (standalone or development)
    PROJECT_ROOT="$SLOP_MOP_DIR"
else
    # slop-mop is a submodule (.git is a file pointing to parent's .git/modules/)
    PROJECT_ROOT="$(cd "$SLOP_MOP_DIR/.." && pwd)"
fi

if [ ! -d "$SLOP_MOP_DIR/slopmop" ]; then
    echo "❌ Error: slopmop module not found at $SLOP_MOP_DIR/slopmop"
    echo "   Run: git submodule update --init"
    exit 1
fi

# Find the project's Python — prefer venv, fall back to system
if [ -f "$PROJECT_ROOT/venv/bin/python" ]; then
    PYTHON="$PROJECT_ROOT/venv/bin/python"
elif [ -f "$PROJECT_ROOT/.venv/bin/python" ]; then
    PYTHON="$PROJECT_ROOT/.venv/bin/python"
elif [ -f "$SLOP_MOP_DIR/venv/bin/python" ]; then
    PYTHON="$SLOP_MOP_DIR/venv/bin/python"
elif command -v python3 &>/dev/null; then
    PYTHON="python3"
else
    echo "❌ Error: No Python found. Install Python 3.9+ or create a venv."
    exit 1
fi

# Run the module directly from the submodule.
# cd to project root first so --project-root defaults to "." work correctly
# regardless of where the caller's working directory is (e.g. git hooks,
# CI steps, or running the wrapper via an absolute path from a subdir).
export PYTHONPATH="$SLOP_MOP_DIR:${PYTHONPATH:-}"
cd "$PROJECT_ROOT"
exec "$PYTHON" -m slopmop.sm "$@"
