#!/bin/bash
# Slop-Mop Setup Script
#
# Sets up slop-mop for a project:
#   1. Creates/finds a Python venv
#   2. Installs all required dependencies
#   3. Creates a convenience `sm` wrapper in the parent project
#   4. Verifies all tools are working
#
# Usage (from parent project root):
#   ./slop-mop/scripts/setup.sh
#
# Or from within slop-mop:
#   ./scripts/setup.sh

set -euo pipefail

# โโโ Resolve paths โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SLOP_MOP_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
PROJECT_ROOT="$(cd "$SLOP_MOP_DIR/.." && pwd)"

echo ""
echo "๐งน Slop-Mop Setup"
echo "============================================================"
echo "๐ Project root:  $PROJECT_ROOT"
echo "๐ Slop-mop dir:  $SLOP_MOP_DIR"
echo ""

# โโโ Step 1: Find or create venv โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
VENV_DIR=""
if [ -d "$PROJECT_ROOT/venv" ]; then
    VENV_DIR="$PROJECT_ROOT/venv"
    echo "โ Found existing venv: $VENV_DIR"
elif [ -d "$PROJECT_ROOT/.venv" ]; then
    VENV_DIR="$PROJECT_ROOT/.venv"
    echo "โ Found existing venv: $VENV_DIR"
else
    VENV_DIR="$PROJECT_ROOT/venv"
    echo "๐ฆ Creating virtual environment: $VENV_DIR"
    python3 -m venv "$VENV_DIR"
    echo "โ Virtual environment created"
fi

PYTHON="$VENV_DIR/bin/python"
PIP="$VENV_DIR/bin/pip"

# Activate for the rest of this script
# shellcheck disable=SC1091
source "$VENV_DIR/bin/activate"

# โโโ Step 2: Upgrade pip โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ฆ Upgrading pip..."
"$PYTHON" -m pip install --upgrade pip --quiet

# โโโ Step 3: Install slop-mop dependencies โโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ฆ Installing slop-mop dependencies..."

# Use requirements.txt as the single source of truth for deps
REQUIREMENTS="$SLOP_MOP_DIR/requirements.txt"
if [ ! -f "$REQUIREMENTS" ]; then
    echo "โ Error: requirements.txt not found at $REQUIREMENTS"
    exit 1
fi

"$PIP" install -r "$REQUIREMENTS" --quiet 2>&1 || {
    echo ""
    echo "โ๏ธ  Some packages failed to install. Trying individually..."
    FAILED=()
    while IFS= read -r line; do
        # Skip comments and empty lines
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue
        "$PIP" install "$line" --quiet 2>&1 || FAILED+=("$line")
    done < "$REQUIREMENTS"
    
    if [ ${#FAILED[@]} -gt 0 ]; then
        echo ""
        echo "โ Failed to install these packages:"
        for pkg in "${FAILED[@]}"; do
            echo "   โข $pkg"
        done
        echo ""
        echo "   These checks may not work until the packages are installed."
        echo "   You can try installing them manually or check platform compatibility."
    fi
}

echo "โ Dependencies installed"

# โโโ Step 4: Create convenience wrapper โโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ Creating 'sm' wrapper script..."

# Determine the relative path from project root to slop-mop
RELATIVE_SM_DIR=$(python3 -c "import os.path; print(os.path.relpath('$SLOP_MOP_DIR', '$PROJECT_ROOT'))")

SM_WRAPPER="$PROJECT_ROOT/scripts/sm"
mkdir -p "$(dirname "$SM_WRAPPER")"

cat > "$SM_WRAPPER" << WRAPPER_EOF
#!/bin/bash
# Auto-generated by slop-mop setup โ runs sm from the local submodule.
# Do NOT install slop-mop via pip. Each project gets its own copy.

SCRIPT_DIR="\$(cd "\$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="\$(cd "\$SCRIPT_DIR/.." && pwd)"
SLOP_MOP_DIR="\$PROJECT_ROOT/$RELATIVE_SM_DIR"

if [ ! -d "\$SLOP_MOP_DIR/slopmop" ]; then
    echo "โ Error: slop-mop submodule not found at \$SLOP_MOP_DIR"
    echo "   Run: git submodule update --init"
    exit 1
fi

# Run the module directly from the submodule
exec "\$PROJECT_ROOT/venv/bin/python" -m slopmop.sm "\$@"
WRAPPER_EOF

chmod +x "$SM_WRAPPER"
echo "โ Wrapper created: $SM_WRAPPER"

# โโโ Step 5: Verify tools โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ Verifying tool availability..."

TOOLS=(
    "black:black --version"
    "isort:isort --version"
    "flake8:flake8 --version"
    "mypy:mypy --version"
    "pyright:pyright --version"
    "pytest:pytest --version"
    "vulture:vulture --version"
    "bandit:bandit --version"
    "detect-secrets:detect-secrets --version"
    "semgrep:semgrep --version"
    "pip-audit:pip-audit --version"
    "autoflake:autoflake --version"
    "diff-cover:diff-cover --version"
)

PASS=0
FAIL=0
MISSING=()

for entry in "${TOOLS[@]}"; do
    IFS=: read -r name cmd <<< "$entry"
    if $cmd &>/dev/null; then
        ((PASS++))
    else
        ((FAIL++))
        MISSING+=("$name")
    fi
done

echo ""
echo "   โ $PASS tools available"
if [ $FAIL -gt 0 ]; then
    echo "   โ๏ธ  $FAIL tools not found:"
    for tool in "${MISSING[@]}"; do
        echo "      โข $tool"
    done
    echo "   Some quality gates may be disabled until these are installed."
fi

# โโโ Step 6: Add PYTHONPATH guidance โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "============================================================"
echo "๐ Setup Complete!"
echo "============================================================"
echo ""
echo "Usage (from project root):"
echo "  PYTHONPATH=$RELATIVE_SM_DIR:\$PYTHONPATH scripts/sm validate commit"
echo ""
echo "Or add to your shell profile / .envrc:"
echo "  export PYTHONPATH=\"$RELATIVE_SM_DIR:\$PYTHONPATH\""
echo ""
echo "Then just:"
echo "  scripts/sm validate commit"
echo "  scripts/sm init"
echo "  scripts/sm config --show"
echo ""
echo "Next: Run 'scripts/sm init' to configure quality gates."
echo ""
